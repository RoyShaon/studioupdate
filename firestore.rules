/**
 * @file Firebase Security Rules for Patient and Medication Label Data
 *
 * Core Philosophy:
 * This ruleset provides simple authentication-based access control for patients and medication labels.
 * Authenticated users can create, read, update, and delete patient and medication label data.
 *
 * Data Structure:
 * - Patients: Stored in the `/patients/{patientId}` collection.
 * - Medication Labels: Stored in the `/patients/{patientId}/medicationLabels/{medicationLabelId}` subcollection.
 *
 * Key Security Decisions:
 * - Authenticated users can manage patient and medication label data.
 * - Denormalization is not used as authorization is based on authentication.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to manage patient data.
     * @path /patients/{patientId}
     * @allow (create) - Authenticated user can create a patient.
     * @deny (create) - Unauthenticated user cannot create a patient.
     * @allow (get) - Authenticated user can retrieve a patient.
     * @deny (get) - N/A
     * @allow (list) - Authenticated user can list patients.
     * @deny (list) - N/A
     * @allow (update) - Authenticated user can update a patient.
     * @deny (update) - Unauthenticated user cannot update a patient.
     * @allow (delete) - Authenticated user can delete a patient.
     * @deny (delete) - Unauthenticated user cannot delete a patient.
     * @principle Authenticated users can manage patients.
     */
    match /patients/{patientId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows authenticated users to manage medication labels for a specific patient.
     * @path /patients/{patientId}/medicationLabels/{medicationLabelId}
     * @allow (create) - Authenticated user can create a medication label.
     * @deny (create) - Unauthenticated user cannot create a medication label.
     * @allow (get) - Authenticated user can retrieve a medication label.
     * @deny (get) - N/A
     * @allow (list) - Authenticated user can list medication labels.
     * @deny (list) - N/A
     * @allow (update) - Authenticated user can update a medication label.
     * @deny (update) - Unauthenticated user cannot update a medication label.
     * @allow (delete) - Authenticated user can delete a medication label.
     * @deny (delete) - Unauthenticated user cannot delete a medication label.
     * @principle Authenticated users can manage medication labels for a specific patient.
     */
    match /patients/{patientId}/medicationLabels/{medicationLabelId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }

  // Helper function to determine if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }
}